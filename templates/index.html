<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal de Relat√≥rios Pronav ‚Äî v2</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --pronav-blue:#035acd;
      --pronav-dark-blue:#023d8c;
      --pronav-light-blue:#468cf5;
      --pronav-gray:#E0E7E9;
      --pronav-light-gray:#F8FAFC;
      --pronav-text:#334155;
      --pronav-border:#E2E8F0;
      --pronav-success:#10B981;
      --pronav-red:#EF4444;
      --pronav-saved:#3B82F6;
      --pronav-card-bg:#fff;
      --pronav-shadow:rgba(0,0,0,0.06);
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Inter',sans-serif;background:linear-gradient(135deg,#f1f5f9 0%,#e2e8f0 100%);color:var(--pronav-text);min-height:100vh;display:flex;flex-direction:column}
    .header{background:linear-gradient(120deg,var(--pronav-blue),var(--pronav-dark-blue));padding:0.75rem 1rem;box-shadow:0 4px 6px -1px var(--pronav-shadow)}
    .main-container{flex:1;background-color:transparent;padding:1rem;overflow:auto}
    .card{background:var(--pronav-card-bg);border-radius:0.6rem;padding:0.75rem;box-shadow:0 8px 18px -6px var(--pronav-shadow)}
    .nav-item{cursor:pointer;padding:.35rem .6rem;border-radius:9999px;font-weight:600;font-size:0.9rem}
    .nav-item.active{background:white;color:var(--pronav-blue)}

    .btn-primary{background:linear-gradient(90deg,var(--pronav-blue),var(--pronav-light-blue));color:#fff;font-weight:600;padding:.36rem .7rem;border-radius:9999px;font-size:0.92rem;border:none}
    .btn-secondary{background:var(--pronav-saved);color:#fff;padding:.36rem .7rem;border-radius:9999px;font-size:0.92rem;border:none}
    .btn-delete{background:var(--pronav-red);color:#fff;padding:.36rem .7rem;border-radius:9999px;border:none}

    .form-label{font-weight:700;margin-bottom:.25rem;font-size:0.9rem}
    .form-control{border:1px solid var(--pronav-border);border-radius:.5rem;padding:.36rem .5rem;width:100%;background:var(--pronav-light-gray);min-height:36px;font-size:0.94rem}
    .form-control:focus{outline:none;border-color:var(--pronav-blue);background:#fff;box-shadow:0 0 0 4px rgba(3,90,205,.06)}
    .form-control.error{border-color:var(--pronav-red)}
    .section-title{font-weight:700;color:var(--pronav-dark-blue);margin-bottom:0.5rem;font-size:1rem}
    footer{background:var(--pronav-dark-blue);color:#fff;padding:0.6rem;text-align:center;margin-top:auto;font-size:0.85rem}

    .saved-list { display:flex; flex-direction:column; gap:8px; }
    .activity-item.compact { padding: 0.5rem; border-radius: 10px; display:flex; align-items:center; gap:10px; justify-content:space-between; background: #fff; box-shadow: 0 2px 6px rgba(2,6,23,0.04); border: 1px solid var(--pronav-border); min-height:56px; }
    .compact .meta{flex:1;min-width:0}
    .compact .meta p:first-child{font-weight:700;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .compact .meta p.meta-sub{margin:2px 0 0 0;font-size:0.78rem;color:#64748b;}
    .compact .actions{display:flex;gap:8px;margin-left:8px}

    .btn-icon { border-radius:8px; padding:0.4rem; cursor:pointer; border: none; display:inline-flex; align-items:center; justify-content:center; min-width:38px; height:38px; box-shadow:0 2px 6px rgba(2,6,23,0.04); }
    .btn-icon i { font-size:14px; }

    .activity-item.grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 0.6rem; position: relative; padding: 0.75rem; border: 1px solid var(--pronav-border); border-radius: 0.6rem; background-color: #fff; }
    @media (min-width: 640px) { .activity-item.grid { grid-template-columns: repeat(6, minmax(0, 1fr)); } }
    @media (min-width: 1024px) { .activity-item.grid { grid-template-columns: repeat(12, minmax(0, 1fr)); gap:0.6rem; } }
    .activity-item.grid > * { min-width: 0; }
    .col-span-12 { grid-column: 1 / -1; }
    @media (min-width:640px) { .md-span-2 { grid-column: span 2; } .md-span-3 { grid-column: span 3; } .md-span-4 { grid-column: span 4; } .md-span-6 { grid-column: span 6; } }
    @media (min-width:1024px) { .c2 { grid-column: span 2; } .c3 { grid-column: span 3; } .c4 { grid-column: span 4; } .c6 { grid-column: span 6; } .c12{ grid-column: 1 / -1; } }

    .time-pair { display:flex; gap:0.45rem; align-items:center; width:100%; }
    .description-full { width:100%; min-height:72px; resize:vertical; white-space:pre-wrap; }

    .tech-row { display:flex; gap:0.5rem; justify-content:flex-start; align-items:flex-start; flex-wrap:wrap; margin-top:6px; }
    .tech-box { width:100%; max-width:220px; display:flex; flex-direction:column; align-items:flex-start; }
    .tech-box + .tech-box input { text-align: left; }

    .remove-activity-btn { position:absolute; top:4px; right:10px; width:30px; height:30px; border-radius:999px; background:#ef4444; color:#fff; border:none; display:inline-flex; align-items:center; justify-content:center; font-size:0.8rem; z-index:5; }

    .form-actions { display:flex; justify-content:center; gap:0.6rem; flex-wrap:wrap; margin-top:0.4rem; }
    @media (min-width:640px) { .form-actions { justify-content:flex-end; } }

    .uppercase-input { text-transform:uppercase; }

    .equip-list { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .equip-item { display:flex; gap:8px; align-items:center; }
    .equip-item input { font-size:0.9rem; }
    .equip-mini { min-width:0; flex:1; }
    .equip-remove { background:#FFF1F2; color:#991B1B; border-radius:8px; padding:6px; border:none; cursor:pointer; }

    .field-help { font-size:0.78rem; color:#64748b; margin-top:6px; }
    .desc-prefix { font-weight:700; margin-bottom:6px; white-space:pre-wrap; color:#1f2937; }
    .desc-prefix.hidden { display:none; }

    /* Image uploader styles */
    .uploader { border: 2px dashed var(--pronav-border); border-radius: 0.6rem; padding: 12px; background: linear-gradient(180deg,#ffffffaa,#ffffff00); transition: border-color .15s, box-shadow .15s; }
    .uploader.dragover { border-color: var(--pronav-blue); box-shadow: 0 6px 18px rgba(3,90,205,0.08); background: linear-gradient(180deg,#f8fbff,#fff) }
    .thumb-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; }
    @media (max-width: 768px) { .thumb-grid { grid-template-columns: repeat(2, 1fr); } }
    .thumb { border-radius: 8px; overflow:hidden; position:relative; background:#fff; border:1px solid var(--pronav-border); display:flex; flex-direction:column; align-items:stretch; }
    .thumb img { width:100%; height:140px; object-fit:cover; display:block; background:#f3f4f6 }
    .thumb .caption { padding:8px; display:flex; gap:6px; align-items:center; }
    .thumb .caption input { flex:1; padding:.35rem .5rem; border:1px solid var(--pronav-border); border-radius:6px; background:var(--pronav-light-gray) }
    .thumb .remove { position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.6); color:white; border-radius:999px; width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; border:none }
    .uploader-meta { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:8px; }
    .small-muted { font-size:0.85rem; color:#64748b }
    .progress-line { height:6px; background:var(--pronav-gray); border-radius:6px; overflow:hidden }
    .progress-line > i { display:block; height:100%; background:linear-gradient(90deg,var(--pronav-blue),var(--pronav-light-blue)); width:0%; transition:width .3s ease; }

    #image-count { font-weight:600; color:var(--pronav-dark-blue) }

    /* wrapper for the Add button placed below activities (only visual change allowed) */
    #__add-activity-wrapper { display:flex; justify-content:flex-end; width:100%; margin-top:8px; }
    #add-activity-btn { align-self:flex-end; z-index:1000; }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <header class="header text-white w-full py-3 px-4 flex flex-col md:flex-row items-center justify-between sticky top-0 z-50">
    <div class="flex items-center space-x-3 mb-3 md:mb-0">
      <div class="w-10 h-10 rounded-lg bg-white bg-opacity-10 flex items-center justify-center">
        <img src="https://i.ibb.co/vCxfFg0S/pronav.png" alt="Logo Pronav" class="h-8" />
      </div>
      <div>
        <h1 class="text-lg font-bold">Portal de Relat√≥rios</h1>
        <p class="text-xs font-light opacity-80">Pronav Marine</p>
      </div>
    </div>

    <div class="flex items-center space-x-3">
      <button id="new-report-nav" class="nav-item active" aria-controls="new-report-view"><i class="fas fa-plus mr-2"></i>Novo Relat√≥rio</button>
      <button id="saved-reports-nav" class="nav-item" aria-controls="saved-reports-view"><i class="fas fa-folder mr-2"></i>Relat√≥rios Salvos</button>
    </div>
  </header>

  <main class="main-container flex-grow p-4">
    <div id="new-report-view" class="max-w-5xl mx-auto w-full">
      <div class="card p-4">
        <h2 class="section-title">Dados do Relat√≥rio</h2>
        <form id="report-form" class="space-y-3" autocomplete="off" novalidate onsubmit="return false;">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label for="CLIENTE" class="form-label">Cliente</label>
              <input id="CLIENTE" name="CLIENTE" required class="form-control uppercase-input" type="text" placeholder="Nome da empresa/contratante" />
            </div>
            <div>
              <label for="NAVIO" class="form-label">Embarca√ß√£o / Navio</label>
              <input id="NAVIO" name="NAVIO" required class="form-control uppercase-input" type="text" placeholder="Nome ou identifica√ß√£o do navio" />
            </div>
            <div>
              <label for="CONTATO" class="form-label">Contato</label>
              <input id="CONTATO" name="CONTATO" required class="form-control uppercase-input" type="text" placeholder="Pessoa ou setor de contato" />
            </div>
            <div>
              <label for="OBRA" class="form-label">Obra</label>
              <input id="OBRA" name="OBRA" required class="form-control uppercase-input" type="text" placeholder="N√∫mero obra" />
            </div>
            <div>
              <label for="LOCAL" class="form-label">Local</label>
              <input id="LOCAL" name="LOCAL" required class="form-control uppercase-input" type="text" placeholder="Ex.: PORTO DO A√áU" />
            </div>
            <div>
              <label for="CIDADE" class="form-label">Cidade</label>
              <input id="CIDADE" name="CIDADE" class="form-control uppercase-input" type="text" placeholder="Ex: CAMPOS DOS GOYTACAZES" />
            </div>
            <div>
              <label for="ESTADO" class="form-label">Estado</label>
              <select id="ESTADO" name="ESTADO" class="form-control">
                <option value="">Selecione o estado</option>
                <option value="AL">AL</option>
                <option value="BA">BA</option>
                <option value="CE">CE</option>
                <option value="ES">ES</option>
                <option value="PA">PA</option>
                <option value="PE">PE</option>
                <option value="RJ">RJ</option>
                <option value="RN">RN</option>
                <option value="RS">RS</option>
                <option value="SC">SC</option>
                <option value="SP">SP</option>
                <option value="SE">SE</option>
              </select>
            </div>
            <div>
              <label for="OS" class="form-label">N√∫mero da OS</label>
              <input id="OS" name="OS" required class="form-control uppercase-input" type="text" placeholder="N√∫mero da ordem de servi√ßo" />
            </div>

            <div>
              <label for="EQUIPAMENTO" class="form-label">Equipamento (principal)</label>
              <input id="EQUIPAMENTO" name="EQUIPAMENTO" required class="form-control uppercase-input" type="text" placeholder="Nome do equipamento principal" />
            </div>
            <div>
              <label for="FABRICANTE" class="form-label">Fabricante</label>
              <input id="FABRICANTE" name="FABRICANTE" required class="form-control uppercase-input" type="text" placeholder="Fabricante do equipamento" />
            </div>
            <div>
              <label for="MODELO" class="form-label">Modelo</label>
              <input id="MODELO" name="MODELO" required class="form-control uppercase-input" type="text" placeholder="Modelo do equipamento" />
            </div>
            <div>
              <label for="NUMERO_SERIE" class="form-label">N¬∫ de S√©rie</label>
              <input id="NUMERO_SERIE" name="NUMERO_SERIE" required class="form-control uppercase-input" type="text" placeholder="N√∫mero de s√©rie" />
            </div>
          </div>

          <div>
            <div class="flex items-center justify-between">
              <h3 class="section-title">Equipamentos (adicionais)</h3>
              <div>
                <button type="button" id="add-equipment-btn" class="btn-secondary px-3 py-1 text-sm"><i class="fas fa-plus mr-2"></i>Adicionar equipamento</button>
              </div>
            </div>
            <div id="equipments-container" class="equip-list" aria-live="polite"></div>
          </div>

          <div class="space-y-2">
            <div>
              <label for="PROBLEMA_RELATADO" class="form-label">Problema Relatado</label>
              <textarea id="PROBLEMA_RELATADO" name="PROBLEMA_RELATADO" required rows="3" class="form-control" placeholder="Descreva o problema observado (use quebras de linha para itens separados)"></textarea>
            </div>
            <div>
              <label for="SERVICO_REALIZADO" class="form-label">Servi√ßo Realizado</label>
              <textarea id="SERVICO_REALIZADO" name="SERVICO_REALIZADO" required rows="3" class="form-control" placeholder="Descreva as a√ß√µes realizadas"></textarea>
            </div>
            <div>
              <label for="RESULTADO" class="form-label">Resultado</label>
              <textarea id="RESULTADO" name="RESULTADO" required rows="3" class="form-control" placeholder="Resultado/observa√ß√µes finais"></textarea>
            </div>
            <div>
              <label for="PENDENCIAS" class="form-label">Pend√™ncias</label>
              <textarea id="PENDENCIAS" name="PENDENCIAS" required rows="2" class="form-control" placeholder="Tarefas pendentes / follow-up"></textarea>
            </div>
          </div>

          <div>
            <h3 class="section-title">Materiais</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label for="MATERIAL_CLIENTE" class="form-label">Material Fornecido pelo Cliente</label>
                <textarea id="MATERIAL_CLIENTE" name="MATERIAL_CLIENTE" required rows="2" class="form-control" placeholder="Lista de materiais do cliente (se houver)"></textarea>
              </div>
              <div>
                <label for="MATERIAL_PRONAV" class="form-label">Material Fornecido pela Pronav</label>
                <textarea id="MATERIAL_PRONAV" name="MATERIAL_PRONAV" required rows="2" class="form-control" placeholder="Lista de materiais fornecidos pela Pronav"></textarea>
              </div>
            </div>
          </div>

          <div>
            <div class="flex items-center justify-between gap-2 flex-wrap mb-2">
              <h3 class="section-title">Atividades</h3>
            </div>

            <!-- activities container stays here -->
            <div id="activities-container" class="space-y-4"></div>

            <!-- ADD BUTTON moved to start BELOW the activities container (initial position at bottom) -->
            <div id="__add-activity-wrapper">
              <button type="button" id="add-activity-btn" class="btn-primary rounded-full px-3 py-1 text-sm">
                <i class="fas fa-plus mr-2"></i> Adicionar
              </button>
            </div>
          </div>

          <!-- IMAGES UPLOADER -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <h3 class="section-title">Fotos do Relat√≥rio</h3>
              <div class="small-muted">As fotos aparecer√£o no PDF em p√°ginas dedicadas ‚Äî 3 imagens por linha.</div>
            </div>

            <div id="uploader" class="uploader" tabindex="0" aria-label="√Årea de upload de imagens">
              <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-3">
                  <button type="button" id="pick-images-btn" class="btn-primary px-3 py-1 text-sm"><i class="fas fa-camera mr-2"></i> Escolher fotos</button>
                  <div class="small-muted">Arraste e solte imagens aqui ou selecione do dispositivo. M√°x. <span id="image-limit-label">50</span>.</div>
                </div>
                <div class="uploader-meta">
                  <div id="image-count" class="small-muted">0 imagens selecionadas</div>
                  <div style="width:240px">
                    <div class="progress-line" aria-hidden="true"><i id="upload-progress"></i></div>
                  </div>
                </div>
              </div>

              <input id="images-input" name="images" type="file" accept="image/*" multiple class="hidden" />

              <div id="thumbs" class="thumb-grid mt-3" aria-live="polite"></div>
            </div>

            <div class="mt-2 small-muted">Legenda: coloque abaixo de cada miniatura. Cada linha com at√© 3 imagens ter√° a legenda combinada no PDF.</div>
          </div>

          <div class="form-actions">
            <button type="button" id="save-btn" class="btn-secondary"><i class="fas fa-save mr-2"></i> Salvar Rascunho</button>
            <button type="submit" id="submit-btn" class="btn-primary"><i class="fas fa-file-pdf mr-2"></i> Gerar PDF</button>
          </div>
        </form>
      </div>
    </div>

    <div id="saved-reports-view" class="max-w-3xl mx-auto hidden mt-4">
      <div class="card p-3">
        <h2 class="section-title">Relat√≥rios Salvos</h2>
        <div id="saved-reports-list" class="space-y-2 saved-list">
          <p id="no-reports-message" class="text-gray-500 text-center">Nenhum relat√≥rio salvo ainda.</p>
        </div>
      </div>
    </div>

    <div id="success-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
      <div class="bg-white rounded-xl p-6 shadow-xl max-w-sm w-full text-center">
        <div class="mb-3"><i class="fas fa-check-circle text-green-500 text-3xl"></i></div>
        <h3 class="font-bold mb-1">Sucesso</h3>
        <p id="success-text" class="text-gray-600 mb-3">Opera√ß√£o realizada com sucesso.</p>
        <button id="close-modal-btn" class="btn-primary px-4 py-1 rounded-full text-white font-semibold">Fechar</button>
      </div>
    </div>

    <div id="error-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
      <div class="bg-white rounded-xl p-6 shadow-xl max-w-sm w-full text-center">
        <div class="mb-3"><i class="fas fa-exclamation-circle text-red-500 text-3xl"></i></div>
        <h3 class="font-bold mb-1">Erro</h3>
        <p id="error-message" class="text-gray-600 mb-3">Ocorreu um erro.</p>
        <button id="close-error-btn" class="btn-primary px-4 py-1 rounded-full text-white font-semibold">Fechar</button>
      </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
      <div class="bg-white rounded-xl p-6 shadow-xl max-w-sm w-full text-center">
        <div class="mb-3"><i class="fas fa-question-circle text-yellow-500 text-3xl"></i></div>
        <h3 class="font-bold mb-1">Confirma√ß√£o</h3>
        <p id="confirm-message" class="text-gray-600 mb-3">Confirma√ß√£o necess√°ria.</p>
        <div class="flex justify-center space-x-3">
          <button id="confirm-cancel-btn" class="px-4 py-1 rounded-full bg-gray-200">Cancelar</button>
          <button id="confirm-ok-btn" class="px-4 py-1 rounded-full btn-delete text-white">OK</button>
        </div>
      </div>
    </div>

  </main>

  <footer class="py-3 px-4 text-center text-sm">
    <p class="text-gray-400">&copy; 2025 Portal de Relat√≥rios Pronav. Todos os direitos reservados.</p>
  </footer>

  <script type="module">
    /* ===========================
       Front-end script atualizado
       - Upload de imagens com legendas
       - Pr√©-visualiza√ß√£o responsiva (grid 3x/2x)
       - Compress√£o/resizing no cliente (opcional, para melhorar UX)
       - Envio multipart/form-data com campo 'payload' (JSON) + imagens (campo 'images') e captions[] 
       - Mant√©m comportamento anterior quando n√£o h√° imagens (envia JSON)
       =========================== */

    // CONFIG
    const MAX_IMAGES = 50;
    const MAX_IMAGE_WIDTH_PX = 1800;    // client-side resize max width
    const MAX_IMAGE_HEIGHT_PX = 1800;   // client-side resize max height
    const JPEG_QUALITY = 0.85;          // canvas toBlob quality (0..1)
    const MAX_UPLOAD_BYTES_HINT = 400000; // hint for the server-side (not enforced here)
    const userId = 'anonymous_user';

    // DOM refs
    const reportForm = document.getElementById('report-form');
    const activitiesContainer = document.getElementById('activities-container');
    const addActivityBtn = document.getElementById('add-activity-btn');
    const submitBtn = document.getElementById('submit-btn');
    const saveBtn = document.getElementById('save-btn');
    const newReportNav = document.getElementById('new-report-nav');
    const savedReportsNav = document.getElementById('saved-reports-nav');
    const savedReportsList = document.getElementById('saved-reports-list');
    const noReportsMessage = document.getElementById('no-reports-message');
    const successModal = document.getElementById('success-modal');
    const errorModal = document.getElementById('error-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const closeErrorBtn = document.getElementById('close-error-btn');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmOkBtn = document.getElementById('confirm-ok-btn');
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

    const imagesInput = document.getElementById('images-input');
    const pickImagesBtn = document.getElementById('pick-images-btn');
    const uploader = document.getElementById('uploader');
    const thumbs = document.getElementById('thumbs');
    const imageCountEl = document.getElementById('image-count');
    const uploadProgress = document.getElementById('upload-progress');
    const imageLimitLabel = document.getElementById('image-limit-label');

    imageLimitLabel.textContent = String(MAX_IMAGES);

    // state: array of { id, file (Blob), originalFileName, dataUrl, caption }
    let imagesArray = [];

    // -------------------------
    // utility helpers
    // -------------------------
    const showModal = (modal, message='') => {
      if (!modal) return;
      if (message) {
        const selector = modal.querySelector('#confirm-message, #error-message, #success-text');
        if (selector) selector.textContent = message;
      }
      modal.classList.remove('hidden'); modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    };
    const hideModal = (modal) => {
      if (!modal) return;
      modal.classList.add('hidden'); modal.classList.remove('flex');
      document.body.style.overflow = '';
    };

    // async resize/compress image file -> returns Blob (jpeg)
    async function resizeImageFile(file, maxW = MAX_IMAGE_WIDTH_PX, maxH = MAX_IMAGE_HEIGHT_PX, quality = JPEG_QUALITY) {
      if (!file || !file.type.startsWith('image/')) return file;
      // for small images skip resizing
      try {
        const imgBitmap = await createImageBitmap(file);
        let iw = imgBitmap.width, ih = imgBitmap.height;
        let scale = Math.min(1, maxW / iw, maxH / ih);
        if (scale >= 0.995) {
          // no resize, but still convert to jpeg to normalize orientation issues if any
          const canvas = document.createElement('canvas');
          canvas.width = iw;
          canvas.height = ih;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(imgBitmap, 0, 0);
          return await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', quality));
        } else {
          const nw = Math.max(1, Math.round(iw * scale));
          const nh = Math.max(1, Math.round(ih * scale));
          const canvas = document.createElement('canvas');
          canvas.width = nw;
          canvas.height = nh;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(imgBitmap, 0, 0, nw, nh);
          return await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', quality));
        }
      } catch (err) {
        // fallback: return original file
        return file;
      }
    }

    function bytesToSize(bytes) {
      if (!bytes) return '0 B';
      const sizes = ['B','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
    }

    function updateThumbsUI() {
      thumbs.innerHTML = '';
      imagesArray.forEach((it, idx) => {
        const div = document.createElement('div');
        div.className = 'thumb';
        div.setAttribute('data-idx', String(idx));
        div.innerHTML = `
          <button type="button" aria-label="Remover imagem" class="remove" title="Remover"><i class="fas fa-times"></i></button>
          <img alt="Foto ${idx+1}" src="${it.dataUrl || ''}" />
          <div class="caption">
            <input type="text" placeholder="Legenda (ser√° usada na linha das imagens)" value="${escapeHtml(it.caption || '')}" />
          </div>
          <div style="padding:6px;font-size:0.78rem;color:#64748b;display:flex;justify-content:space-between;align-items:center">
              <span>Imagem ${idx + 1}</span> <!-- Nome gen√©rico -->
              <small>${it.fileSize ? bytesToSize(it.fileSize) : ''}</small>
          </div>
        `;
        thumbs.appendChild(div);

        // handlers
        const removeBtn = div.querySelector('.remove');
        removeBtn.addEventListener('click', () => {
          imagesArray = imagesArray.filter((x,i)=> i !== idx);
          updateThumbsUI();
          updateImageCount();
        });

        const captionInput = div.querySelector('.caption input');
        captionInput.addEventListener('input', (e) => {
          imagesArray[idx].caption = e.target.value;
        });
      });

      // graceful fallback message if empty
      if (imagesArray.length === 0) {
        thumbs.innerHTML = `<div class="small-muted col-span-3">Nenhuma imagem adicionada.</div>`;
      }
    }

    function updateImageCount() {
      imageCountEl.textContent = `${imagesArray.length} imagem${imagesArray.length === 1 ? '' : 'ens'} selecionada${imagesArray.length === 1 ? '' : 's'}`;
      // reset progress bar
      uploadProgress.style.width = '0%';
    }

    function escapeHtml(s) {
      if (!s) return '';
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
    }

    // handle files from input or drop
    async function handleFiles(fileList) {
      if (!fileList || fileList.length === 0) return;
      const availableSlots = MAX_IMAGES - imagesArray.length;
      if (availableSlots <= 0) { showModal(errorModal, `Limite de ${MAX_IMAGES} imagens atingido.`); return; }
      const toProcess = Array.from(fileList).slice(0, availableSlots);

      submitBtn.disabled = true;
      pickImagesBtn.disabled = true;
      let processed = 0;

      for (const f of toProcess) {
        try {
          // client-side resize/compress
          const resizedBlob = await resizeImageFile(f, MAX_IMAGE_WIDTH_PX, MAX_IMAGE_HEIGHT_PX, JPEG_QUALITY);
          const dataUrl = await blobToDataURL(resizedBlob);
          const fileSize = (resizedBlob.size || (f.size || 0));
          imagesArray.push({
            id: cryptoRandomId(),
            file: resizedBlob,
            originalFileName: f.name,
            dataUrl,
            caption: '',
            fileSize
          });
        } catch (err) {
          console.warn('erro ao processar imagem', err);
          // add original file as fallback
          const dataUrl = await fileToDataUrlFallback(f);
          imagesArray.push({ id: cryptoRandomId(), file: f, originalFileName: f.name, dataUrl, caption: '', fileSize: f.size || 0 });
        } finally {
          processed++;
          uploadProgress.style.width = `${Math.round((processed / toProcess.length) * 100)}%`;
        }
      }

      updateThumbsUI();
      updateImageCount();
      submitBtn.disabled = false;
      pickImagesBtn.disabled = false;
    }

    function fileToDataUrlFallback(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => resolve('');
        reader.readAsDataURL(file);
      });
    }

    function blobToDataURL(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error('toDataURL failed'));
        reader.readAsDataURL(blob);
      });
    }

    function cryptoRandomId() {
      try {
        return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
          (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        );
      } catch {
        return String(Math.random()).slice(2,10);
      }
    }

    // -------------------------
    // uploader UI events
    // -------------------------
    pickImagesBtn.addEventListener('click', () => imagesInput.click());
    imagesInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
      imagesInput.value = '';
    });

    // drag & drop
    ['dragenter','dragover'].forEach(ev => {
      uploader.addEventListener(ev, (e) => {
        e.preventDefault(); e.stopPropagation();
        uploader.classList.add('dragover');
      }, {passive:false});
    });
    ['dragleave','drop','dragend'].forEach(ev => {
      uploader.addEventListener(ev, (e) => {
        e.preventDefault(); e.stopPropagation();
        uploader.classList.remove('dragover');
      }, {passive:false});
    });
    uploader.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      if (!dt) return;
      const files = dt.files;
      handleFiles(files);
    });

    // keyboard accessibility to open file picker
    uploader.addEventListener('keydown', (e) => {
      // N√£o executar se o evento veio de um campo de input (como legenda)
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        return;
      }
      
      if (e.key === 'Enter' || e.key === ' ') { 
        e.preventDefault(); 
        imagesInput.click(); 
      }
    });

    // -------------------------
    // existing form logic (activities, equipments, etc.)
    // largely preserved from original code, minimal adjustments
    // -------------------------
    const uppercaseFields = ['CLIENTE','NAVIO','CONTATO','OBRA','LOCAL','OS','EQUIPAMENTO','FABRICANTE','MODELO','NUMERO_SERIE','CIDADE'];
    uppercaseFields.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('input', (ev) => {
        const pos = el.selectionStart;
        el.value = el.value.toUpperCase();
        try { el.setSelectionRange(pos, pos); } catch(e){}
      });
    });

    function updateSubmitButtonState() { submitBtn.disabled = activitiesContainer.children.length === 0; }
    function clearForm() { reportForm.reset(); activitiesContainer.innerHTML = ''; document.getElementById('equipments-container').innerHTML = ''; addActivity(true); imagesArray = []; updateThumbsUI(); updateImageCount(); currentDocRef = null; }

    const equipmentsContainer = document.getElementById('equipments-container');
    const addEquipmentBtn = document.getElementById('add-equipment-btn');

    function addEquipment(data = null) {
      const div = document.createElement('div');
      div.className = 'equip-item';
      div.innerHTML = `
        <input class="form-control equip-mini uppercase-input" placeholder="Equipamento" data-key="equip" />
        <input class="form-control equip-mini uppercase-input" placeholder="Fabricante" data-key="fabricante" />
        <input class="form-control equip-mini uppercase-input" placeholder="Modelo" data-key="modelo" />
        <input class="form-control equip-mini uppercase-input" placeholder="N¬∫ S√©rie" data-key="sn" />
        <button type="button" class="equip-remove" title="Remover equipamento" aria-label="Remover equipamento">&times;</button>
      `;
      equipmentsContainer.appendChild(div);
      const removeBtn = div.querySelector('.equip-remove');
      removeBtn.addEventListener('click', () => div.remove());
      if (data && typeof data === 'object') {
        div.querySelector('[data-key="equip"]').value = (data.equipamento || data.EQUIPAMENTO || '') ;
        div.querySelector('[data-key="fabricante"]').value = (data.fabricante || data.FABRICANTE || '') ;
        div.querySelector('[data-key="modelo"]').value = (data.modelo || data.MODELO || '') ;
        div.querySelector('[data-key="sn"]').value = (data.numero_serie || data.NUMERO_SERIE || '') ;
      }
      div.querySelectorAll('.uppercase-input').forEach(inp => {
        inp.addEventListener('input', (e) => {
          const pos = inp.selectionStart;
          inp.value = inp.value.toUpperCase();
          try { inp.setSelectionRange(pos, pos); } catch(e){}
        });
      });
      return div;
    }

    const KM_BLOCKED_TYPES = [
      'm√£o-de-obra t√©cnica',
      'm√£o-de-obra-t√©cnica',
      'per√≠odo de espera',
      'viagem a√©rea',
      'translado'
    ].map(s => s.toLowerCase());

    const TRAVEL_TYPES = [
      'viagem terrestre',
      'viagem a√©rea',
      'translado'
    ].map(s => s.toLowerCase());

    function applyTipoRulesToActivity(activityEl) {
      try {
        if (!activityEl) return;
        const tipoEl = activityEl.querySelector('[name="TIPO"]');
        const kmEl = activityEl.querySelector('[name="KM"]');
        const motivoEl = activityEl.querySelector('[name="MOTIVO"]');
        const origemEl = activityEl.querySelector('[name="ORIGEM"]');
        const destinoEl = activityEl.querySelector('[name="DESTINO"]');
        const prefixEl = activityEl.querySelector('.desc-prefix');

        if (!tipoEl || !kmEl) return;
        const t = (tipoEl.value || '').toString().trim().toLowerCase();

        if (KM_BLOCKED_TYPES.includes(t)) {
          kmEl.value = '';
          kmEl.disabled = true;
          kmEl.removeAttribute('required');
        } else {
          kmEl.disabled = false;
          kmEl.setAttribute('required','required');
        }

        if (motivoEl) {
          if (t === 'per√≠odo de espera') {
            motivoEl.disabled = false;
            motivoEl.setAttribute('required','required');
          } else {
            motivoEl.value = '';
            motivoEl.disabled = true;
            motivoEl.removeAttribute('required');
          }
        }

        if (origemEl && destinoEl) {
          if (TRAVEL_TYPES.includes(t)) {
            origemEl.disabled = false;
            destinoEl.disabled = false;
            origemEl.setAttribute('required','required');
            destinoEl.setAttribute('required','required');
          } else {
            origemEl.value = '';
            destinoEl.value = '';
            origemEl.disabled = true;
            destinoEl.disabled = true;
            origemEl.removeAttribute('required');
            destinoEl.removeAttribute('required');
          }
        }

        let descVal = '';
        if (t === 'm√£o-de-obra t√©cnica' || t === 'm√£o de obra t√©cnica' || t === 'm√£o-de-obra-t√©cnica') {
          descVal = 'M√£o-de-Obra-T√©cnica';
        } else if (t === 'per√≠odo de espera') {
          if (motivoEl && !motivoEl.disabled && motivoEl.value.trim()) descVal = motivoEl.value.trim();
        } else if (TRAVEL_TYPES.includes(t)) {
          const o = (origemEl && origemEl.value) ? origemEl.value.trim() : '';
          const d = (destinoEl && destinoEl.value) ? destinoEl.value.trim() : '';
          if (o || d) descVal = `${o} x ${d}`;
        } else {
          if (prefixEl && !prefixEl.classList.contains('hidden') && prefixEl.textContent) {
            descVal = String(prefixEl.textContent || '').trim();
          }
        }

        if (descVal) {
          prefixEl.textContent = descVal;
          prefixEl.classList.remove('hidden');
        } else {
          prefixEl.textContent = '';
          prefixEl.classList.add('hidden');
        }

      } catch (err) {
        console.error('applyTipoRulesToActivity error (handled):', err);
      }
    }

    function addActivity(isInitial = false, data = null) {
      const count = activitiesContainer.querySelectorAll('.activity-item').length;
      if (count >= 30 && !isInitial) { showModal(errorModal, 'M√°ximo de 30 atividades permitidas.'); return; }

      const div = document.createElement('div');
      div.className = 'activity-item grid';
      div.innerHTML = `
        <button type="button" class="remove-activity-btn" title="Remover atividade"><i class="fas fa-times"></i></button>
        <div class="c2">
          <label class="form-label block">Data</label>
          <input name="DATA" required class="form-control" type="date">
        </div>
        <div class="c2">
          <label class="form-label block">Hora In√≠cio</label>
          <input name="HORA_INICIO" required class="form-control" type="time" placeholder="HH:MM">
        </div>
        <div class="c2">
          <label class="form-label block">Hora Fim</label>
          <input name="HORA_FIM" required class="form-control" type="time" placeholder="HH:MM">
        </div>
        <div class="c3">
          <label class="form-label block">Tipo</label>
          <select name="TIPO" required class="form-control">
            <option value="M√£o-de-obra T√©cnica">M√£o-de-obra T√©cnica</option>
            <option value="Per√≠odo de Espera">Per√≠odo de Espera</option>
            <option value="Viagem Terrestre">Viagem Terrestre</option>
            <option value="Viagem A√©rea">Viagem A√©rea</option>
            <option value="Translado">Translado</option>
          </select>
        </div>
        <div class="c3">
          <label class="form-label block">Km</label>
          <input name="KM" class="form-control" type="text" inputmode="numeric" style="flex:1;" required>
        </div>
        <div class="c12" style="margin-top:6px">
          <div class="desc-prefix hidden" aria-hidden="true"></div>
          <div class="field-help">Descri√ß√£o ser√° gerada pelo sistema. Preencha Motivo/Origem/Destino conforme necess√°rio.</div>
        </div>
        <div class="c12" style="display:flex;gap:8px;">
          <div style="flex:1">
            <label class="form-label block">Motivo (apenas Per√≠odo de Espera)</label>
            <input name="MOTIVO" class="form-control" type="text" disabled placeholder="Somente em Per√≠odo de Espera">
            <div class="field-help">Preenchido somente se Per√≠odo de Espera</div>
          </div>
          <div style="flex:1;display:flex;gap:8px;">
            <div style="flex:1">
              <label class="form-label block">Origem</label>
              <input name="ORIGEM" class="form-control" type="text" disabled placeholder="Local de origem (viagens)">
              <div class="field-help">Local de origem (viagens)</div>
            </div>
            <div style="flex:1">
              <label class="form-label block">Destino</label>
              <input name="DESTINO" class="form-control" type="text" disabled placeholder="Local de destino (viagens)">
              <div class="field-help">Local de destino (viagens)</div>
            </div>
          </div>
        </div>
        <div class="c12">
          <div class="tech-row">
            <div class="tech-box">
              <label class="form-label">T√©cnico 1</label>
              <input name="TECNICO1" required class="form-control" type="text">
            </div>
            <div class="tech-box">
              <label class="form-label">T√©cnico 2 (opcional)</label>
              <input name="TECNICO2" class="form-control" type="text">
            </div>
          </div>
        </div>
      `;

      activitiesContainer.appendChild(div);

      // remover atividade
      div.querySelector('.remove-activity-btn').addEventListener('click', () => { div.remove(); updateSubmitButtonState(); });

      // listeners para atualizar regras ao mudar campos
      const tipoEl = div.querySelector('[name="TIPO"]');
      const motivoEl = div.querySelector('[name="MOTIVO"]');
      const origemEl = div.querySelector('[name="ORIGEM"]');
      const destinoEl = div.querySelector('[name="DESTINO"]');

      if (tipoEl) tipoEl.addEventListener('change', () => applyTipoRulesToActivity(div));
      if (motivoEl) motivoEl.addEventListener('input', () => applyTipoRulesToActivity(div));
      if (origemEl) origemEl.addEventListener('input', () => applyTipoRulesToActivity(div));
      if (destinoEl) destinoEl.addEventListener('input', () => applyTipoRulesToActivity(div));

      // populate values if data provided
      if (data && typeof data === 'object') {
        try {
          const setIf = (selectorName, value) => {
            const el = div.querySelector(`[name="${selectorName}"]`);
            if (el && value !== undefined && value !== null) el.value = value;
          };
          setIf('DATA', data.DATA || data.data || '');
          setIf('HORA_INICIO', data.HORA_INICIO || data.hora_inicio || '');
          setIf('HORA_FIM', data.HORA_FIM || data.hora_fim || '');
          setIf('TIPO', data.TIPO || data.tipo || '');
          setIf('KM', data.KM || data.km || '');
          setIf('MOTIVO', data.MOTIVO || data.motivo || '');
          setIf('ORIGEM', data.ORIGEM || data.origem || '');
          setIf('DESTINO', data.DESTINO || data.destino || '');
          setIf('TECNICO1', data.TECNICO1 || data.tecnico1 || '');
          setIf('TECNICO2', data.TECNICO2 || data.tecnico2 || '');
          applyTipoRulesToActivity(div);
        } catch (e) { console.error(e); }
      } else {
        applyTipoRulesToActivity(div);
      }

      updateSubmitButtonState();

      if (!isInitial && !data) {
        try {
          div.scrollIntoView({ behavior: 'smooth', block: 'center' });
          const firstInput = div.querySelector('[name="DATA"]');
          if (firstInput) {
            setTimeout(() => { try { firstInput.focus(); } catch(e){} }, 260);
          }
        } catch (e) { /* ignore */ }
      }
      return div;
    }

    function validateForm() {
      const required = reportForm.querySelectorAll('[required]');
      let ok = true;
      required.forEach(f => {
        if (f.disabled) return;
        if (!f.value || f.value.toString().trim() === '') {
          f.classList.add('error');
          ok = false;
        } else {
          f.classList.remove('error');
        }
      });
      if (activitiesContainer.children.length === 0) {
        showModal(errorModal, 'Adicione pelo menos uma atividade.');
        ok = false;
      }
      const activities = activitiesContainer.querySelectorAll('.activity-item');
      activities.forEach(item => {
        const h1 = item.querySelector('[name="HORA_INICIO"]');
        const h2 = item.querySelector('[name="HORA_FIM"]');
        if (!h1.value || !h2.value) {
          if (h1) h1.classList.add('error');
          if (h2) h2.classList.add('error');
          ok = false;
        }
      });
      return ok;
    }

    function buildPayloadObject() {
      const fd = new FormData(reportForm);
      const payload = {
        CLIENTE: fd.get('CLIENTE') || '',
        NAVIO: fd.get('NAVIO') || '',
        CONTATO: fd.get('CONTATO') || '',
        OBRA: fd.get('OBRA') || '',
        LOCAL: fd.get('LOCAL') || '',
        CIDADE: fd.get('CIDADE') || '',
        ESTADO: fd.get('ESTADO') || '',
        OS: fd.get('OS') || '',
        EQUIPAMENTO: fd.get('EQUIPAMENTO') || '',
        FABRICANTE: fd.get('FABRICANTE') || '',
        MODELO: fd.get('MODELO') || '',
        NUMERO_SERIE: fd.get('NUMERO_SERIE') || '',
        PROBLEMA_RELATADO: fd.get('PROBLEMA_RELATADO') || '',
        SERVICO_REALIZADO: fd.get('SERVICO_REALIZADO') || '',
        RESULTADO: fd.get('RESULTADO') || '',
        PENDENCIAS: fd.get('PENDENCIAS') || '',
        MATERIAL_CLIENTE: fd.get('MATERIAL_CLIENTE') || '',
        MATERIAL_PRONAV: fd.get('MATERIAL_PRONAV') || '',
        user_id: userId || 'anonymous_user',
        activities: [],
        EQUIPAMENTOS: []
      };

      // Primeiro equipamento (campos principais)
      const firstEquip = {
        equipamento: payload.EQUIPAMENTO || '',
        fabricante: payload.FABRICANTE || '',
        modelo: payload.MODELO || '',
        numero_serie: payload.NUMERO_SERIE || ''
      };
      if (firstEquip.equipamento || firstEquip.fabricante || firstEquip.modelo || firstEquip.numero_serie) {
        payload.EQUIPAMENTOS.push(firstEquip);
      }

      // Equipamentos adicionais
      const equipItems = equipmentsContainer.querySelectorAll('.equip-item');
      equipItems.forEach(el => {
        const equip = (el.querySelector('[data-key="equip"]') && el.querySelector('[data-key="equip"]').value) || '';
        const fab = (el.querySelector('[data-key="fabricante"]') && el.querySelector('[data-key="fabricante"]').value) || '';
        const mod = (el.querySelector('[data-key="modelo"]') && el.querySelector('[data-key="modelo"]').value) || '';
        const sn = (el.querySelector('[data-key="sn"]') && el.querySelector('[data-key="sn"]').value) || '';
        if (equip || fab || mod || sn) {
          payload.EQUIPAMENTOS.push({
            equipamento: equip, fabricante: fab, modelo: mod, numero_serie: sn
          });
        }
      });

      // Activities / Atividades (se houver)
      const actItems = activitiesContainer.querySelectorAll('.activity-item');
      actItems.forEach(el => {
        const title = (el.querySelector('[data-key="title"]') && el.querySelector('[data-key="title"]').value) || '';
        const desc = (el.querySelector('[data-key="desc"]') && el.querySelector('[data-key="desc"]').value) || '';
        if (title || desc) payload.activities.push({title, description: desc});
      });

      // Outros campos din√¢micos (se existirem) podem ser adicionados aqui

      return payload;
    }

    // -------------------------
    // Submit / Generate report
    // - if imagesArray not empty -> send multipart/form-data:
    //    - field 'payload' -> JSON string (report payload)
    //    - fields 'images' -> files (multiple)
    //    - fields 'captions[]' -> captions matched by order
    //    - also add caption_{i} for compatibility
    // - else send JSON as before
    // -------------------------
    // No arquivo index.html - dentro da fun√ß√£o generateReport()

  // No arquivo index.html - dentro da fun√ß√£o generateReport()

  async function generateReport() {
      if (!validateForm()) { showModal(errorModal, 'Preencha os campos obrigat√≥rios.'); return; }
      submitBtn.disabled = true;
      try {
        const payload = buildPayloadObject();

        if (imagesArray && imagesArray.length > 0) {
        // build FormData
        const fd = new FormData();

        // === FIX CR√çTICO: inserir legendas dentro do payload JSON para garantir que o backend
        // encontre as legendas ao fazer json.loads(request.form['payload'])
        try {
          payload.captions = imagesArray.map(it => it.caption || '');
          // Compatibilidade: tamb√©m adicione uma chave 'captions[]' no payload
          payload['captions[]'] = imagesArray.map(it => it.caption || '');
        } catch (e) { console.warn('Erro ao montar payload.captions', e); }

        fd.append('payload', JSON.stringify(payload));

        // Enviar imagens + legendas em m√∫ltiplos formatos para m√°xima compatibilidade:
        imagesArray.forEach((it, idx) => {
          const blob = it.file instanceof Blob ? it.file : it;
          // usar nomes neutros (n√£o o nome original do usu√°rio)
          const filename = `imagem_${idx + 1}.jpg`;
          
          // Arquivo
          fd.append('images', blob, filename);
          
          // Manda como captions[index] (array) ‚Äî muitos backends aceitam assim:
          fd.append(`captions[${idx}]`, it.caption || '');
          
          // Manda tamb√©m como caption_i por compatibilidade com parsers individuais
          fd.append(`caption_${idx}`, it.caption || '');
        });

        // Tamb√©m adiciona um "captions[]" como conven√ß√£o comum
        imagesArray.forEach((it, idx) => {
          fd.append('captions[]', it.caption || '');
        });

        // DEBUG (opcional)
        console.log('üîÑ DEBUG FRONTEND: Enviando para o backend:');
        console.log('- Quantidade de imagens:', imagesArray.length);
        console.log('- Legendas:', imagesArray.map(img => img.caption));
        for (let pair of fd.entries()) {
          if (pair[0].includes('caption') || pair[0] === 'images') {
            console.log(`FormData: ${pair[0]} =`, pair[1]);
          }
        }

        // enviar multipart
        const res = await fetch('/gerar-relatorio', { method: 'POST', body: fd });
        if (!res.ok) {
            const body = await res.json().catch(()=>null);
            const msg = body ? (body.error || JSON.stringify(body)) : await res.text();
            showModal(errorModal, 'Erro ao gerar relat√≥rio: ' + msg);
            return;
        } else {
          const reportId = res.headers.get('X-Report-Id');
          if (reportId) currentDocRef = reportId;
          const blob = await res.blob();
          downloadBlob(blob, payload);
          showModal(successModal, 'Relat√≥rio gerado com sucesso!');
        }
      } else {
        // caso sem imagens: enviar s√≥ JSON (opcional)
        const res = await fetch('/gerar-relatorio-json', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok) { showModal(errorModal, 'Erro ao gerar relat√≥rio (sem imagens).'); return; }
        const blob = await res.blob();
        downloadBlob(blob, payload);
        showModal(successModal, 'Relat√≥rio gerado com sucesso!');
      }
      } catch (err) {
        console.error(err);
        showModal(errorModal, 'Erro de rede: ' + (err.message || err));
      } finally {
        submitBtn.disabled = false;
      }
    }

    function downloadBlob(blob, payload) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.style.display='none'; a.href = url;
      const shipSafe = (payload.NAVIO || 'Geral').replace(/\s+/g,'_');
      const date = new Date().toISOString().replace(/[:.]/g,'-').split('T')[0];
      const equipName = (payload.EQUIPAMENTOS && payload.EQUIPAMENTOS[0]) ? (payload.EQUIPAMENTOS[0].equipamento || '') : '';
      const equipSafe = equipName ? ('_' + String(equipName).replace(/\s+/g,'_')) : '';
      a.download = `PRONAV_${date}_${shipSafe}${equipSafe}.pdf`;
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
    }

    // -------------------------
    // Save Draft (JSON only) - unchanged behaviour
    // -------------------------
    async function saveDraftToBackend(isUpdate=false) {
      if (!validateForm()) { showModal(errorModal, 'Preencha os campos obrigat√≥rios antes de salvar.'); return; }
      saveBtn.disabled = true;
      try {
        const payload = buildPayloadObject();
        if (isUpdate && currentDocRef) {
          const res = await fetch(`/atualizar-relatorio/${currentDocRef}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          const body = await res.json().catch(()=>null);
          if (!res.ok) { showModal(errorModal, 'Erro ao atualizar rascunho: ' + (body?.error || JSON.stringify(body))); return; }
          showModal(successModal, 'Rascunho atualizado com sucesso!');
        } else {
          const res = await fetch('/salvar-rascunho', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          const body = await res.json().catch(()=>null);
          if (!res.ok) { showModal(errorModal, 'Erro ao salvar rascunho: ' + (body?.error || JSON.stringify(body))); return; }
          if (body && body.report_id) currentDocRef = body.report_id;
          showModal(successModal, 'Rascunho salvo com sucesso!');
        }
      } catch (e) {
        console.error(e);
        showModal(errorModal, 'Erro ao salvar rascunho: ' + (e.message || e));
      } finally { saveBtn.disabled = false; }
    }

    // -------------------------
    // helpers for saved reports loading / editing (kept as before, minimal edits)
    // -------------------------
    function tryParseDate(value) {
      if (!value) return null;
      if (typeof value === 'number') return new Date(value > 1e12 ? value : value * 1000);
      const n = Number(value);
      if (!isNaN(n)) return new Date(n > 1e12 ? n : n * 1000);
      const d = new Date(value);
      return isNaN(d.getTime()) ? null : d;
    }
    function formatDateTimeISO(value) {
      const d = tryParseDate(value);
      if (!d) return value || '';
      try {
        return d.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'America/Sao_Paulo' });
      } catch(e) {
        return d.toLocaleString('pt-BR');
      }
    }

    function renderSavedReports(reports) {
      savedReportsList.innerHTML = '';
      if (!reports || reports.length === 0) { noReportsMessage.classList.remove('hidden'); return; }
      noReportsMessage.classList.add('hidden');

      reports.forEach(r => {
        const id = r.id || r.report_id || r.ID || r._id || '';
        const client = (r.CLIENTE || r.client || '').toString().toUpperCase();
        const ship = (r.NAVIO || r.ship || '').toString().toUpperCase();
        const createdRaw = r.updated_at || r.created_at || r.updatedAt || r.createdAt || '';
        const createdPretty = formatDateTimeISO(createdRaw);

        const div = document.createElement('div');
        div.className = 'activity-item compact';
        div.innerHTML = `
          <div class="meta">
            <p title="${client} ‚Äî ${ship}">${client}${client && ship ? ' - ' : ''}${ship}</p>
            <p class="meta-sub">Atualizado em: <time datetime="${createdRaw}">${createdPretty}</time></p>
          </div>
          <div class="actions" role="group" aria-label="A√ß√µes do relat√≥rio">
            <button title="Editar" class="btn-icon edit edit-report-btn" data-id="${id}" aria-label="Editar relat√≥rio ${id}"><i class="fas fa-edit"></i></button>
            <button title="Baixar" class="btn-icon download download-report-btn" data-id="${id}" aria-label="Baixar relat√≥rio ${id}"><i class="fas fa-download"></i></button>
            <button title="Deletar" class="btn-icon delete delete-report-btn" data-id="${id}" aria-label="Deletar relat√≥rio ${id}"><i class="fas fa-trash-alt"></i></button>
          </div>
        `;
        savedReportsList.appendChild(div);
      });
    }

    async function loadSavedReports() {
      savedReportsList.innerHTML = '';
      noReportsMessage.classList.remove('hidden');
      try {
        const res = await fetch(`/relatorios-salvos?user_id=${encodeURIComponent(userId)}`);
        if (!res.ok) {
          const txt = await res.text().catch(()=>null);
          savedReportsList.innerHTML = `<div class="p-2 text-sm text-red-600">Erro ao carregar relat√≥rios (server: ${res.status}). ${txt ? ('Mensagem: '+txt) : ''}</div>`;
          return;
        }
        const arr = await res.json();
        renderSavedReports(arr);
      } catch (e) {
        console.error(e);
        savedReportsList.innerHTML = `<div class="p-2 text-sm text-red-600">Erro ao carregar relat√≥rios: ${e.message || e}</div>`;
      }
    }

    async function loadReportFromBackend(id) {
      try {
        const res = await fetch(`/relatorio/${id}`);
        if (!res.ok) {
          const body = await res.json().catch(()=>null);
          showModal(errorModal, 'Erro ao carregar relat√≥rio: ' + (body?.error || JSON.stringify(body)));
          return;
        }
        const d = await res.json();

        // mapping and populating form (kept same as before but trimmed)
        const pad2 = (n) => String(n).padStart(2,'0');
        function toDateInputFormat(value) {
          if (!value && value !== 0) return '';
          if (value instanceof Date) return `${value.getFullYear()}-${pad2(value.getMonth()+1)}-${pad2(value.getDate())}`;
          if (typeof value === 'number') {
            const dt = value > 1e12 ? new Date(value) : new Date(value * 1000);
            if (!isNaN(dt.getTime())) return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`;
          }
          let s = String(value || '').trim();
          if (!s) return '';
          let m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
          if (m) return `${m[1]}-${m[2]}-${m[3]}`;
          m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})/);
          if (m) return `${m[3]}-${m[2]}-${m[1]}`;
          const dIso = new Date(s);
          if (!isNaN(dIso.getTime())) return `${dIso.getFullYear()}-${pad2(dIso.getMonth()+1)}-${pad2(dIso.getDate())}`;
          return '';
        }

        function parseCombinedHour(s) {
          if (!s) return { start: '', end: '' };
          const text = String(s).trim();
          const seps = ['√†s','as','-','‚Äì','‚Äî','/',' a '];
          for (const sep of seps) {
            if (text.includes(sep)) {
              const parts = text.split(sep);
              if (parts.length >= 2) {
                const a = parts[0].trim();
                const b = parts[1].trim();
                return { start: normalizeTimeToken(a) || '', end: normalizeTimeToken(b) || '' };
              }
            }
          }
          const single = normalizeTimeToken(text);
          return { start: single || '', end: '' };
        }

        function normalizeTimeToken(tok) {
          if (!tok) return null;
          let s = String(tok).trim();
          s = s.replace(/\s+/g, '').replace('h',':').replace('H',':').replace('.',':');
          const m = s.match(/^(\d{1,2}):?(\d{0,2})$/);
          if (m) {
            const hh = parseInt(m[1],10);
            const mm = m[2] ? parseInt(m[2],10) : 0;
            if (isNaN(hh) || hh < 0 || hh > 23) return null;
            const mmv = (isNaN(mm) || mm < 0 || mm > 59) ? 0 : mm;
            return `${pad2(hh)}:${pad2(mmv)}`;
          }
          const m2 = s.match(/^(\d{2})(\d{2})$/);
          if (m2) return `${m2[1]}:${m2[2]}`;
          return null;
        }

        const map = {
          'CLIENTE': (d.client || d.CLIENTE || '').toString().toUpperCase(),
          'NAVIO': (d.ship || d.NAVIO || '').toString().toUpperCase(),
          'CONTATO': (d.contact || d.CONTATO || '').toString().toUpperCase(),
          'OBRA': (d.work || d.OBRA || '').toString().toUpperCase(),
          'LOCAL': (d.location || d.LOCAL || '').toString().toUpperCase(),
          'OS': (d.os_number || d.OS || '').toString().toUpperCase(),
          'EQUIPAMENTO': d.equipment || d.EQUIPAMENT–û || '',
          'FABRICANTE': d.manufacturer || d.FABRICANTE || '',
          'MODELO': d.model || d.MODELO || '',
          'NUMERO_SERIE': d.serial_number || d.NUMERO_SERIE || '',
          'PROBLEMA_RELATADO': d.reported_problem || d.PROBLEMA_RELATADO || '',
          'SERVICO_REALIZADO': d.service_performed || d.SERVICO_REALIZADO || '',
          'RESULTADO': d.result || d.RESULTADO || '',
          'PENDENCIAS': d.pending_issues || d.PENDENCIAS || '',
          'MATERIAL_CLIENTE': d.client_material || d.MATERIAL_CLIENTE || '',
          'MATERIAL_PRONAV': d.pronav_material || d.MATERIAL_PRONAV || '',
          'CIDADE': d.CIDADE || d.city || '',
          'ESTADO': d.ESTADO || d.state || ''
        };
        Object.keys(map).forEach(k => { const el = document.getElementById(k); if (el) el.value = map[k] || ''; });

        // equipamentos
        equipmentsContainer.innerHTML = '';
        const eqs = d.EQUIPAMENTOS || d.equipamentos || [];
        if (Array.isArray(eqs) && eqs.length > 0) {
          const first = eqs[0] || {};
          if (first.equipamento) document.getElementById('EQUIPAMENTO').value = (first.equipamento || '');
          if (first.fabricante) document.getElementById('FABRICANTE').value = (first.fabricante || '');
          if (first.modelo) document.getElementById('MODELO').value = (first.modelo || '');
          if (first.numero_serie) document.getElementById('NUMERO_SERIE').value = (first.numero_serie || '');
          eqs.slice(1).forEach(e => addEquipment(e));
        }

        // atividades
        activitiesContainer.innerHTML = '';
        let acts = [];
        if (Array.isArray(d.activities)) acts = d.activities;
        else if (d.activities) {
          try { acts = JSON.parse(d.activities); } catch (e) { acts = []; }
        }

        if (!Array.isArray(acts) || acts.length === 0) {
          addActivity(true);
        } else {
          const normalizedActs = acts.map(raw => {
            const a = Object.assign({}, raw || {});
            a.DATA = toDateInputFormat(a.DATA || a.data || '');
            const hasHi = !!(a.HORA_INICIO || a.hora_inicio || a.horainicio);
            const hasHf = !!(a.HORA_FIM || a.hora_fim || a.horafim);
            const horaLegacy = a.HORA || a.hora || '';
            if (!hasHi && !hasHf && horaLegacy) {
              const parsed = parseCombinedHour(horaLegacy);
              if (parsed.start) a.HORA_INICIO = parsed.start;
              if (parsed.end) a.HORA_FIM = parsed.end;
            } else {
              if (a.HORA_INICIO) {
                const t = normalizeTimeToken(a.HORA_INICIO);
                if (t) a.HORA_INICIO = t;
              }
              if (a.HORA_FIM) {
                const t = normalizeTimeToken(a.HORA_FIM);
                if (t) a.HORA_FIM = t;
              }
            }
            a.TIPO = a.TIPO || a.tipo || '';
            a.KM = a.KM || a.km || '';
            a.DESCRICAO = a.DESCRICAO || a.descricao || a.description || '';
            a.TECNICO1 = (a.TECNICO1 || a.tecnico1 || a.tecnico || '') ;
            a.TECNICO2 = (a.TECNICO2 || a.tecnico2 || '') ;
            a.MOTIVO = a.MOTIVO || a.motivo || '';
            a.ORIGEM = a.ORIGEM || a.origem || '';
            a.DESTINO = a.DESTINO || a.destino || '';
            return a;
          });
          normalizedActs.forEach(a => addActivity(false, a));
        }

        currentDocRef = id;

        setTimeout(() => {
          const all = activitiesContainer.querySelectorAll('.activity-item');
          all.forEach(it => applyTipoRulesToActivity(it));
        }, 20);

        document.getElementById('new-report-view').classList.remove('hidden');
        document.getElementById('saved-reports-view').classList.add('hidden');
        newReportNav.classList.add('active');
        savedReportsNav.classList.remove('active');

      } catch (e) {
        console.error(e);
        showModal(errorModal, 'Erro ao carregar relat√≥rio: ' + (e.message || e));
      }
    }

    async function deleteReportBackend(id) {
      showModal(confirmModal, 'Deseja realmente deletar este relat√≥rio?');
      confirmOkBtn.onclick = async () => {
        hideModal(confirmModal);
        try {
          const res = await fetch(`/relatorio/${id}`, { method: 'DELETE' });
          const body = await res.json().catch(()=>null);
          if (!res.ok) { showModal(errorModal, 'Erro ao deletar relat√≥rio: ' + (body?.error || JSON.stringify(body))); return; }
          showModal(successModal, 'Relat√≥rio deletado com sucesso!');
          loadSavedReports();
        } catch (e) { console.error(e); showModal(errorModal, 'Erro ao deletar relat√≥rio: ' + (e.message || e)); }
      };
    }

    // -------------------------
    // init
    // -------------------------
    let currentDocRef = null;
    document.addEventListener('DOMContentLoaded', () => {
      addActivity(true);
      updateSubmitButtonState();
      updateThumbsUI();
      updateImageCount();

      newReportNav.addEventListener('click', () => {
        document.getElementById('new-report-view').classList.remove('hidden');
        document.getElementById('saved-reports-view').classList.add('hidden');
        newReportNav.classList.add('active');
        savedReportsNav.classList.remove('active');
        clearForm();
      });
      savedReportsNav.addEventListener('click', () => {
        document.getElementById('new-report-view').classList.add('hidden');
        document.getElementById('saved-reports-view').classList.remove('hidden');
        newReportNav.classList.remove('active');
        savedReportsNav.classList.add('active');
        loadSavedReports();
      });

      if (closeModalBtn) closeModalBtn.addEventListener('click', () => hideModal(successModal));
      if (closeErrorBtn) closeErrorBtn.addEventListener('click', () => hideModal(errorModal));
      if (confirmCancelBtn) confirmCancelBtn.addEventListener('click', () => hideModal(confirmModal));

      if (addActivityBtn) addActivityBtn.addEventListener('click', () => addActivity());
      if (addEquipmentBtn) addEquipmentBtn.addEventListener('click', () => addEquipment());

      savedReportsList.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.dataset.id;
        if (btn.classList.contains('edit-report-btn')) { loadReportFromBackend(id);
        } else if (btn.classList.contains('download-report-btn')) {
          (async() => {
            try {
              const res = await fetch(`/relatorio/${id}`);
              if (!res.ok) { showModal(errorModal, 'Erro ao buscar relat√≥rio para download.'); return; }
              const d = await res.json();
              d.report_id = id;
              const gen = await fetch('/gerar-relatorio', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(d) });
              if (!gen.ok) { const err = await gen.json().catch(()=>null); showModal(errorModal, 'Erro ao gerar PDF: ' + (err?.error||JSON.stringify(err))); return; }
              const blob = await gen.blob();
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a'); link.href = url;
              const shipSafe = ((d.NAVIO || d.ship) || 'Geral').replace(/\s+/g,'_');
              const equipName = (d.EQUIPAMENTOS && d.EQUIPAMENTOS[0]) ? (d.EQUIPAMENTOS[0].equipamento || '') : '';
              const equipSafe = equipName ? ('_' + String(equipName).replace(/\s+/g,'_')) : '';
              const date = new Date().toISOString().replace(/[:.]/g,'-').split('T')[0];
              link.download = `PRONAV_${date}_${shipSafe}${equipSafe}.pdf`;
              document.body.appendChild(link); link.click(); URL.revokeObjectURL(url);
            } catch(e){ console.error(e); showModal(errorModal, 'Erro ao baixar relat√≥rio.'); }
          })();
        } else if (btn.classList.contains('delete-report-btn')) {
          deleteReportBackend(id);
        }
      });

      if (saveBtn) saveBtn.addEventListener('click', () => { if (currentDocRef) saveDraftToBackend(true); else saveDraftToBackend(false); });

      reportForm.addEventListener('submit', (e) => { e.preventDefault(); generateReport(); });
    });
  </script>
</body>
</html>
